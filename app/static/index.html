<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Agent - AI Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .stage-indicator {
            transition: all 0.3s ease;
        }
        .stage-active {
            background-color: #3b82f6;
            color: white;
        }
        .stage-complete {
            background-color: #10b981;
            color: white;
        }
        .stage-pending {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Podcast Agent</h1>
            <p class="text-gray-600">Multi-agent AI system for podcast transcript analysis with fact-checking</p>
        </header>

        <!-- Input Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">Input Transcript</h2>

            <!-- Tabs -->
            <div class="flex space-x-4 mb-4 border-b">
                <button onclick="switchTab('sample')" id="tab-sample" class="px-4 py-2 font-medium border-b-2 border-blue-500 text-blue-600">
                    Sample Transcripts
                </button>
                <button onclick="switchTab('upload')" id="tab-upload" class="px-4 py-2 font-medium text-gray-600 hover:text-gray-900">
                    Upload File
                </button>
                <button onclick="switchTab('paste')" id="tab-paste" class="px-4 py-2 font-medium text-gray-600 hover:text-gray-900">
                    Paste Text
                </button>
            </div>

            <!-- Sample Tab -->
            <div id="content-sample" class="tab-content">
                <label class="block text-sm font-medium text-gray-700 mb-2">Choose a sample:</label>
                <select id="sample-select" class="w-full p-2 border border-gray-300 rounded-md mb-4">
                    <option value="">Loading samples...</option>
                </select>
                <button onclick="analyzeSample()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                    Analyze Sample
                </button>
            </div>

            <!-- Upload Tab -->
            <div id="content-upload" class="tab-content hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload .txt or .json file:</label>
                <input type="file" id="file-input" accept=".txt,.json" class="w-full p-2 border border-gray-300 rounded-md mb-4">
                <button onclick="analyzeFile()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                    Analyze File
                </button>
            </div>

            <!-- Paste Tab -->
            <div id="content-paste" class="tab-content hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Paste transcript:</label>
                <textarea id="transcript-input" rows="8" class="w-full p-3 border border-gray-300 rounded-md mb-4"
                    placeholder="Paste podcast transcript here (minimum 100 characters)..."></textarea>
                <button onclick="analyzeText()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">
                    Analyze Transcript
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">Processing Progress</h2>

            <!-- Current Agent Indicator -->
            <div class="mb-6">
                <div class="text-sm text-gray-600 mb-2">Current Agent:</div>
                <div id="current-agent-indicator" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg shadow-lg">
                    <div class="flex items-center">
                        <div class="spinner mr-3 border-white border-t-transparent"></div>
                        <div>
                            <div id="current-agent-name" class="font-bold text-lg">Supervisor (Editor-in-Chief)</div>
                            <div id="current-agent-action" class="text-sm opacity-90">Coordinating specialist agents...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Status Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div id="agent-supervisor" class="agent-status p-3 rounded-lg border-2 border-blue-300 bg-blue-50">
                    <div class="font-medium text-sm text-blue-900">Supervisor</div>
                    <div class="text-xs text-blue-700 mt-1">Coordinating</div>
                </div>
                <div id="agent-summarizer" class="agent-status stage-pending p-3 rounded-lg border-2 border-gray-200">
                    <div class="font-medium text-sm">Summarizer</div>
                    <div class="text-xs text-gray-600 mt-1">Pending</div>
                </div>
                <div id="agent-notes" class="agent-status stage-pending p-3 rounded-lg border-2 border-gray-200">
                    <div class="font-medium text-sm">Note Extractor</div>
                    <div class="text-xs text-gray-600 mt-1">Pending</div>
                </div>
                <div id="agent-factcheck" class="agent-status stage-pending p-3 rounded-lg border-2 border-gray-200">
                    <div class="font-medium text-sm">Fact Checker</div>
                    <div class="text-xs text-gray-600 mt-1">Pending</div>
                </div>
            </div>

            <!-- Thought Process Panel -->
            <div class="mb-6">
                <h3 class="font-semibold mb-3 text-gray-700">Thought Process & Agent Activity</h3>
                <div id="thought-process-panel" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto space-y-2">
                    <div class="text-sm text-gray-500 italic">Waiting for supervisor decisions...</div>
                </div>
            </div>

            <!-- Progress Messages -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h3 class="font-medium mb-2 flex items-center text-blue-900">
                    <div class="spinner mr-2 border-blue-600 border-t-transparent"></div>
                    System Messages
                </h3>
                <div id="progress-messages" class="text-sm text-blue-800 space-y-1 max-h-48 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Processing Timeline -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">Processing Timeline</h2>
                <div id="timeline-container" class="space-y-2"></div>
            </div>

            <!-- Quality Metrics Dashboard -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">Quality Metrics</h2>
                <div class="grid md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600" id="metric-confidence">-</div>
                        <div class="text-sm text-gray-600 mt-1">Overall Confidence</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600" id="metric-research">-</div>
                        <div class="text-sm text-gray-600 mt-1">Research Quality</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600" id="metric-critic">-</div>
                        <div class="text-sm text-gray-600 mt-1">Critic Score</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-orange-600" id="metric-iterations">-</div>
                        <div class="text-sm text-gray-600 mt-1">Critic Iterations</div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">Summary</h2>
                <p id="result-summary" class="text-gray-700 mb-4"></p>

                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="font-semibold mb-2">Main Topics</h3>
                        <ul id="result-topics" class="list-disc list-inside space-y-1 text-gray-700"></ul>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Key Takeaways</h3>
                        <ul id="result-takeaways" class="list-disc list-inside space-y-1 text-gray-700"></ul>
                    </div>
                </div>

                <div id="quotes-section" class="mb-4"></div>
            </div>

            <!-- Fact Check Results -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Fact-Checked Claims</h2>
                <div id="fact-check-table" class="overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <script>
        let currentEventSource = null;
        let timelineEvents = [];
        let modelData = {
            model_a: null,
            model_b: null,
            supervisor: null,
            fact_check: null,
            critic: null
        };
        let qualityMetrics = {
            research_quality: null,
            critic_score: null
        };

        // Load samples on page load
        document.addEventListener('DOMContentLoaded', loadSamples);

        async function loadSamples() {
            try {
                const response = await fetch('/api/samples');
                const data = await response.json();
                const select = document.getElementById('sample-select');

                if (data.samples.length === 0) {
                    select.innerHTML = '<option value="">No samples available</option>';
                } else {
                    select.innerHTML = '<option value="">Select a sample...</option>' +
                        data.samples.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading samples:', error);
            }
        }

        function switchTab(tab) {
            // Update tab buttons
            ['sample', 'upload', 'paste'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`content-${t}`);
                if (t === tab) {
                    btn.classList.add('border-blue-500', 'text-blue-600');
                    btn.classList.remove('text-gray-600');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                    btn.classList.add('text-gray-600');
                    content.classList.add('hidden');
                }
            });
        }

        async function analyzeSample() {
            const select = document.getElementById('sample-select');
            const sampleId = select.value;
            if (!sampleId) {
                alert('Please select a sample');
                return;
            }

            try {
                const response = await fetch(`/api/samples/${sampleId}`);
                const data = await response.json();
                startAnalysis(data);
            } catch (error) {
                alert('Error loading sample: ' + error.message);
            }
        }

        async function analyzeFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            startSSEAnalysis('/api/analyze/file', formData, true);
        }

        function analyzeText() {
            const textarea = document.getElementById('transcript-input');
            const transcript = textarea.value.trim();
            if (transcript.length < 100) {
                alert('Transcript must be at least 100 characters');
                return;
            }

            startAnalysis({ transcript });
        }

        function startAnalysis(data) {
            startSSEAnalysis('/api/analyze', JSON.stringify(data), false);
        }

        function startSSEAnalysis(url, body, isFormData) {
            // Reset timeline and model data for new analysis
            timelineEvents = [];
            modelData = {
                model_a: null,
                model_b: null,
                supervisor: null,
                fact_check: null,
                critic: null
            };
            qualityMetrics = {
                research_quality: null,
                critic_score: null
            };

            // Show progress section
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('progress-messages').innerHTML = '';

            // Reset agent status indicators
            document.getElementById('agent-supervisor').className = 'agent-status p-3 rounded-lg border-2 border-blue-300 bg-blue-50';
            document.getElementById('agent-summarizer').className = 'agent-status stage-pending p-3 rounded-lg border-2 border-gray-200';
            document.getElementById('agent-notes').className = 'agent-status stage-pending p-3 rounded-lg border-2 border-gray-200';
            document.getElementById('agent-factcheck').className = 'agent-status stage-pending p-3 rounded-lg border-2 border-gray-200';

            // Reset thought process panel
            document.getElementById('thought-process-panel').innerHTML = '<div class="text-sm text-gray-500 italic">Waiting for supervisor decisions...</div>';

            // Close existing connection
            if (currentEventSource) {
                currentEventSource.close();
            }

            // Use fetch with streaming for POST requests
            const fetchOptions = {
                method: 'POST',
                body: body
            };

            if (!isFormData) {
                fetchOptions.headers = { 'Content-Type': 'application/json' };
            }

            console.log('[SSE] Starting fetch request to:', url);

            fetch(url, fetchOptions)
                .then(response => {
                    console.log('[SSE] Response received, status:', response.status);
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let chunkCount = 0;

                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                console.log('[SSE] Stream complete, total chunks:', chunkCount);
                                return;
                            }

                            chunkCount++;
                            const chunk = decoder.decode(value);
                            console.log(`[SSE] Chunk ${chunkCount} received (${chunk.length} bytes):`, chunk.substring(0, 100));

                            const lines = chunk.split('\n');
                            console.log(`[SSE] Processing ${lines.length} lines from chunk`);

                            lines.forEach((line, idx) => {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonStr = line.substring(6);
                                        console.log(`[SSE] Parsing line ${idx}:`, jsonStr.substring(0, 100));
                                        const data = JSON.parse(jsonStr);
                                        console.log('[SSE] Event parsed successfully:', data.type || data.stage, '|', data.agent || 'N/A');
                                        handleSSEEvent(data);
                                    } catch (parseError) {
                                        console.error('[SSE] JSON parse error:', parseError);
                                        console.error('[SSE] Failed line:', line);
                                        addMessage('‚ö†Ô∏è Parse error: ' + parseError.message, true);
                                    }
                                }
                            });

                            readStream();
                        }).catch(streamError => {
                            console.error('[SSE] Stream read error:', streamError);
                            addMessage('‚ö†Ô∏è Stream error: ' + streamError.message, true);
                        });
                    }

                    readStream();
                })
                .catch(error => {
                    console.error('[SSE] Fetch error:', error);
                    addMessage('Error: ' + error.message, true);
                });
        }

        function handleSSEEvent(data) {
            console.log('[SSE] handleSSEEvent called with data:', data);
            const { stage, message, node, result, type, agent, action, target_agent, details, error } = data;

            // Store timeline event
            if (message && (node || agent)) {
                timelineEvents.push({
                    timestamp: new Date().toLocaleTimeString(),
                    node: node || agent,
                    message: message,
                    stage: stage,
                    type: type
                });
            }

            // Handle different event types
            if (type === 'supervisor_decision') {
                // Supervisor is calling an agent
                updateCurrentAgent(target_agent, message);
                updateAgentStatus(target_agent, 'calling');
                addThoughtProcessMessage('supervisor', `ü§î ${message}`, 'decision');
                addMessage(`Supervisor ‚Üí ${target_agent}`);
            } else if (type === 'agent_complete') {
                // Agent finished its work
                updateAgentStatus(agent, 'complete');
                addThoughtProcessMessage(agent, `‚úì ${message}`, 'complete');
                addMessage(`${agent} completed: ${details || ''}`);

                // Update current agent back to supervisor
                updateCurrentAgent('Supervisor', 'Reviewing results and deciding next steps...');
            } else if (type === 'supervisor_reasoning') {
                // Supervisor's thought process
                addThoughtProcessMessage('supervisor', `üí≠ ${message}`, 'reasoning');
                addMessage(message);
            } else if (type === 'agent_error') {
                // Agent encountered an error
                updateAgentStatus(agent, 'error');
                addThoughtProcessMessage(agent, `‚ùå ${message}`, 'error');
                addMessage(message, true);
            } else if (type === 'node_complete') {
                // Node finished processing
                addMessage(message);
            } else if (message) {
                // Generic message
                addMessage(message);
            }

            // Handle completion
            if (stage === 'complete' && result) {
                updateCurrentAgent('Complete', 'All agents finished successfully!');
                markAllAgentsComplete();
                displayResults(result);
            } else if (stage === 'error') {
                addMessage(message, true);

                // Show enhanced error UI with retry option
                const progressSection = document.getElementById('progress-section');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 border border-red-200 rounded p-4 mt-4';
                errorDiv.innerHTML = `
                    <h3 class="font-semibold text-red-800 mb-2">Analysis Error</h3>
                    <p class="text-red-700 mb-3">${message}</p>
                    <button onclick="location.reload()"
                            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                        Retry Analysis
                    </button>
                `;
                progressSection.appendChild(errorDiv);
            }
        }

        function updateCurrentAgent(agentName, action) {
            const nameEl = document.getElementById('current-agent-name');
            const actionEl = document.getElementById('current-agent-action');

            // Map agent names to display names
            const displayNames = {
                'Summarizing Agent': 'Summarizing Agent',
                'Note Extraction Agent': 'Note Extraction Agent',
                'Fact Checking Agent': 'Fact Checking Agent',
                'Supervisor': 'Supervisor (Editor-in-Chief)',
                'Complete': 'Workflow Complete ‚úì'
            };

            nameEl.textContent = displayNames[agentName] || agentName;
            actionEl.textContent = action;

            // Update indicator color based on agent
            const indicator = document.getElementById('current-agent-indicator');
            if (agentName === 'Complete') {
                indicator.className = 'bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-lg shadow-lg';
            } else if (agentName.includes('Supervisor')) {
                indicator.className = 'bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg shadow-lg';
            } else {
                indicator.className = 'bg-gradient-to-r from-orange-500 to-pink-600 text-white p-4 rounded-lg shadow-lg';
            }
        }

        function updateAgentStatus(agentName, status) {
            // Map agent names to element IDs
            const agentIds = {
                'Summarizing Agent': 'agent-summarizer',
                'Note Extraction Agent': 'agent-notes',
                'Fact Checking Agent': 'agent-factcheck',
                'Supervisor': 'agent-supervisor'
            };

            const elementId = agentIds[agentName];
            if (!elementId) return;

            const el = document.getElementById(elementId);
            const statusDiv = el.querySelector('.text-xs');

            if (status === 'calling') {
                el.className = 'agent-status p-3 rounded-lg border-2 border-orange-400 bg-orange-50';
                statusDiv.textContent = 'Working...';
                statusDiv.className = 'text-xs text-orange-700 mt-1';
            } else if (status === 'complete') {
                el.className = 'agent-status p-3 rounded-lg border-2 border-green-400 bg-green-50';
                statusDiv.textContent = 'Complete ‚úì';
                statusDiv.className = 'text-xs text-green-700 mt-1';
            } else if (status === 'error') {
                el.className = 'agent-status p-3 rounded-lg border-2 border-red-400 bg-red-50';
                statusDiv.textContent = 'Error ‚úó';
                statusDiv.className = 'text-xs text-red-700 mt-1';
            }
        }

        function markAllAgentsComplete() {
            ['Summarizing Agent', 'Note Extraction Agent', 'Fact Checking Agent', 'Supervisor'].forEach(agent => {
                updateAgentStatus(agent, 'complete');
            });
        }

        function addThoughtProcessMessage(agent, message, messageType) {
            const panel = document.getElementById('thought-process-panel');

            // Remove initial placeholder if exists
            if (panel.querySelector('.italic')) {
                panel.innerHTML = '';
            }

            const messageEl = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();

            // Color coding based on message type
            let bgColor = 'bg-gray-100';
            let textColor = 'text-gray-800';
            let borderColor = 'border-gray-300';

            if (messageType === 'decision') {
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-900';
                borderColor = 'border-blue-300';
            } else if (messageType === 'complete') {
                bgColor = 'bg-green-50';
                textColor = 'text-green-900';
                borderColor = 'border-green-300';
            } else if (messageType === 'reasoning') {
                bgColor = 'bg-purple-50';
                textColor = 'text-purple-900';
                borderColor = 'border-purple-300';
            } else if (messageType === 'error') {
                bgColor = 'bg-red-50';
                textColor = 'text-red-900';
                borderColor = 'border-red-300';
            }

            messageEl.className = `${bgColor} ${textColor} border-l-4 ${borderColor} p-2 rounded text-sm`;
            messageEl.innerHTML = `
                <div class="flex items-start">
                    <span class="text-xs opacity-60 mr-2">${timestamp}</span>
                    <span class="flex-1">${message}</span>
                </div>
            `;

            panel.appendChild(messageEl);
            panel.scrollTop = panel.scrollHeight;
        }

        function addMessage(message, isError = false) {
            const messagesDiv = document.getElementById('progress-messages');
            const messageEl = document.createElement('div');
            messageEl.textContent = '‚Ä¢ ' + message;
            if (isError) messageEl.classList.add('text-red-600');
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Legacy functions removed - old stage indicators no longer exist
        // Agent status is now managed by updateAgentStatus() function

        function displayResults(result) {
            // Hide progress section with spinner
            document.getElementById('progress-section').classList.add('hidden');

            // Show results section
            document.getElementById('results-section').classList.remove('hidden');

            // Populate Timeline
            displayTimeline();

            // Populate Quality Metrics (NEW STRUCTURE)
            displayQualityMetricsNew(result);

            // Summary (from summarizing agent)
            if (result.summary && result.summary.summary) {
                document.getElementById('result-summary').textContent = result.summary.summary;
            }

            // Topics (from notes agent)
            if (result.notes && result.notes.topics) {
                const topicsList = document.getElementById('result-topics');
                topicsList.innerHTML = result.notes.topics.map(t => `<li>${parseMarkdown(t)}</li>`).join('');
            }

            // Takeaways (from notes agent)
            if (result.notes && result.notes.top_takeaways) {
                const takeawaysList = document.getElementById('result-takeaways');
                takeawaysList.innerHTML = result.notes.top_takeaways.map(t => `<li>${parseMarkdown(t)}</li>`).join('');
            }

            // Quotes (from notes agent)
            if (result.notes && result.notes.notable_quotes && result.notes.notable_quotes.length > 0) {
                const quotesDiv = document.getElementById('quotes-section');
                quotesDiv.innerHTML = '<h3 class="font-semibold mb-2">Notable Quotes</h3>' +
                    result.notes.notable_quotes.map(q =>
                        `<blockquote class="border-l-4 border-blue-500 pl-4 mb-2 italic text-gray-700">
                            "${q.text}" ${q.speaker ? `‚Äî ${q.speaker}` : ''}
                            ${q.timestamp ? `<span class="text-xs text-gray-500 block mt-1">@ ${q.timestamp}</span>` : ''}
                        </blockquote>`
                    ).join('');
            }

            // Fact check table (from fact checking agent)
            if (result.fact_check && result.fact_check.verified_claims) {
                const tableDiv = document.getElementById('fact-check-table');

                // Check if there are any claims to display
                if (result.fact_check.verified_claims.length > 0) {
                    tableDiv.innerHTML = `
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">Claim</th>
                                    <th class="p-2 text-left">Status</th>
                                    <th class="p-2 text-left">Confidence</th>
                                    <th class="p-2 text-left">Sources</th>
                                    <th class="p-2 text-left">Reasoning</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.fact_check.verified_claims.map(claim => `
                                    <tr class="border-t">
                                        <td class="p-2">${parseMarkdown(claim.claim)}</td>
                                        <td class="p-2">
                                            <span class="px-2 py-1 rounded text-xs ${getStatusColor(claim.verification_status)}">
                                                ${claim.verification_status}
                                            </span>
                                        </td>
                                        <td class="p-2">${(claim.confidence * 100).toFixed(0)}%</td>
                                        <td class="p-2">
                                            ${claim.sources && claim.sources.length > 0 ? claim.sources.map(s =>
                                                `<a href="${s.url}" target="_blank" class="text-blue-600 hover:underline block text-xs">${s.title || s.url}</a>`
                                            ).join('') : '<span class="text-gray-400 text-xs">No sources</span>'}
                                        </td>
                                        <td class="p-2 text-xs text-gray-600">${parseMarkdown(claim.reasoning)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    // Display empty state message
                    tableDiv.innerHTML = `
                        <div class="p-4 bg-gray-50 rounded-lg text-center">
                            <p class="text-gray-500 italic">No factual claims were identified for verification in this podcast.</p>
                        </div>
                    `;
                }
            }
        }

        function displayQualityMetricsNew(result) {
            // Update metrics from new structure
            const metadata = result.metadata || {};

            // Overall confidence (from fact check)
            if (result.fact_check && result.fact_check.overall_reliability !== undefined) {
                document.getElementById('metric-confidence').textContent =
                    (result.fact_check.overall_reliability * 100).toFixed(0) + '%';
            } else {
                document.getElementById('metric-confidence').textContent = 'N/A';
            }

            // Research quality (from fact check)
            if (result.fact_check && result.fact_check.research_quality !== undefined) {
                document.getElementById('metric-research').textContent =
                    (result.fact_check.research_quality * 100).toFixed(0) + '%';
            } else {
                document.getElementById('metric-research').textContent = 'N/A';
            }

            // Agents invoked
            document.getElementById('metric-critic').textContent = metadata.agents_invoked || '3';

            // Total tool calls
            document.getElementById('metric-iterations').textContent = metadata.total_tool_calls || '0';

            // Update metric labels to match new architecture
            const metricLabels = document.querySelectorAll('#results-section .text-sm.text-gray-600.mt-1');
            if (metricLabels[2]) metricLabels[2].textContent = 'Agents Invoked';
            if (metricLabels[3]) metricLabels[3].textContent = 'Total Tool Calls';
        }

        function displayTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = timelineEvents.map(event => {
                const nodeColors = {
                    'model_a': 'bg-blue-100 border-blue-500 text-blue-800',
                    'model_b': 'bg-green-100 border-green-500 text-green-800',
                    'supervisor': 'bg-purple-100 border-purple-500 text-purple-800',
                    'fact_checker': 'bg-orange-100 border-orange-500 text-orange-800',
                    'critic': 'bg-pink-100 border-pink-500 text-pink-800'
                };
                const color = nodeColors[event.node] || 'bg-gray-100 border-gray-500 text-gray-800';
                return `
                    <div class="flex items-start space-x-3 ${color} border-l-4 p-3 rounded">
                        <div class="text-xs font-mono text-gray-500">${event.timestamp}</div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm">${formatNodeName(event.node)}</div>
                            <div class="text-sm">${event.message}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function parseMarkdown(text) {
            if (!text) return '';
            return marked.parse(text);
        }

        function formatNodeName(node) {
            const names = {
                'supervisor': 'Supervisor (Llama Maverick)'
            };
            return names[node] || node;
        }

        function getStatusColor(status) {
            const colors = {
                'verified': 'bg-green-100 text-green-800',
                'partially_verified': 'bg-yellow-100 text-yellow-800',
                'unverified': 'bg-gray-100 text-gray-800',
                'false': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function displayDownloadButtons(outputFiles) {
            // Create download section if it doesn't exist
            let downloadSection = document.getElementById('download-section');
            if (!downloadSection) {
                const resultsSection = document.getElementById('results-section');
                downloadSection = document.createElement('div');
                downloadSection.id = 'download-section';
                downloadSection.className = 'mt-6 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200';

                // Insert before results section
                if (resultsSection && resultsSection.parentNode) {
                    resultsSection.parentNode.insertBefore(downloadSection, resultsSection);
                } else {
                    document.body.appendChild(downloadSection);
                }
            }

            // Build download buttons HTML
            const buttonsHtml = `
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">Analysis Complete!</h3>
                        <p class="text-sm text-gray-600">Download your detailed analysis results:</p>
                    </div>
                    <div class="flex gap-3">
                        ${outputFiles.json ? `
                            <a href="/api/download/${outputFiles.json}"
                               download="${outputFiles.json}"
                               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download JSON
                            </a>
                        ` : ''}
                        ${outputFiles.markdown ? `
                            <a href="/api/download/${outputFiles.markdown}"
                               download="${outputFiles.markdown}"
                               class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-sm">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Markdown
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;

            downloadSection.innerHTML = buttonsHtml;
            downloadSection.classList.remove('hidden');
        }
    </script>
</body>
</html>
